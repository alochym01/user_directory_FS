wget http://files.freeswitch.org/yum/freeswitch-release-1-0.noarch.rpm
rpm -ivh freeswitch-release-1-0.noarch.rpm
yum install -y freeswitch mysql-server httpd freeswitch-config-vanilla freeswitch-sounds-music-8000 freeswitch-sounds-en-us-callie-8000 freeswitch-timer-posix  freeswitch-xml-cdr  freeswitch-xml-curl php php-mysql
tao user trong mysql
	1.	mysql
	2.	mysql> create user 'freeswitch'@'localhost' identified by 'freeswitch';
	3.	tao databases: mysql> create database freeswitch;
	4.	gan quyen cho user tren database freeswitch: mysql> grant all privileges on freeswitch.* to 'freeswitch'@'localhost';

CREATE TABLE subscriber (
 id INT(10) UNSIGNED AUTO_INCREMENT PRIMARY KEY NOT NULL,\
 username CHAR(64) DEFAULT '' NOT NULL,\
 context CHAR(64) DEFAULT '' NOT NULL,\
 toll_allow CHAR(64) DEFAULT '' NULL,\
 password CHAR(25) DEFAULT '' NOT NULL \
) ENGINE=MyISAM;

insert into subscriber(username, context, password, toll_allow) value("2000", "default", "1234", "local");

config freeswitch use http cho user
	1.	edit file vi /etc/freeswitch/autoload_configs/modules.conf.xml - uncomment mod_xml_curl
	2.	edit file vi /etc/freeswitch/autoload_configs/xml_curl.com.xml - them dong http://IP_ADDR/user.php
	3.	wget http://pkgs.repoforge.org/ngrep/ngrep-1.45-2.el5.rf.i386.rpm
	4.	start FS
	5.	config regoster vao fpt : /etc/freeswitch/sip_profiles/external/fpt.xml
		<include>
		  <gateway name="sia-HCM1CA146.fpt.net">		  
			<param name="username" value="0873002769"/>
			<param name="password" value="abc0873002769"/>
			<param name="expire-seconds" value="3600"/>
			<param name="register" value="true"/>
			<param name="retry-seconds" value="30"/>
		  <!--send an options ping every x seconds, failure will unregister and/or mark it down-->
		  <!--<param name="ping" value="25"/>-->
		  </gateway>
		</include>

	file php de query dayabases
<?php

#server localhost
  $server_name = "localhost";

#username de login vao mysql server
  $user_name = "freeswitch";

#password of username login
  $password = "freeswitch";

#databse of data
  $database_name = "freeswitch";

#create connection to connect mysql server
  $connect = mysql_connect($server_name, $user_name, $password) or die("Could not connect: " . mysql_error());

#use the database name
  $db_select = mysql_select_db($database_name, $connect) or die("Not connected : " . mysql_error());

#check the file POST request from freeswitch to see below http POST method contents
  $user=$_POST["user"];

#query database base on user reest
  $result = mysql_query("SELECT * FROM subscriber where username=$user");

#pharse the result of sql query
  $mysql_result = mysql_fetch_array($result);

#check if user is exist or not
  if(!$mysql_result){
    echo '<?xml version="1.0" encoding="utf-8"?>' . "\n";
    echo '<document type="freeswitch/xml">' . "\n";
    echo ' <section name="result">' . "\n";
    echo '  <result status="not found">' . "\n";
    echo ' </section>' . "\n";
    echo '</document>' . "\n";
  }

#print the result
  else{
    echo '<?xml version="1.0" encoding="utf-8"?>' . "\n";
    echo '<document type="freeswitch/xml">' . "\n";
    echo ' <section name="directory">' . "\n" ;
    echo '  <domain name="' . $_POST['domain']. '">' . "\n" ;
    echo '   <user id="' . $mysql_result['username'] . '">' . "\n" ;
    echo '    <params>' . "\n";
    echo '     <param name="dial-string" value="{presence_id=${dialed_user}@${dialed_domain}}${sofia_contact(${dialed_user}@${dialed_domain})}"/>';
	echo '     <param name="password" value="' . $mysql_result['password'] . '"/>' . "\n" ;
    echo '    </params>' . "\n";
    echo '    <variables>' . "\n";
    echo '     <variable name="toll_allow" value="' . $mysql_result['toll_allow'] . '"/>' . "\n" ;
    echo '     <variable name="user_context" value="' . $mysql_result['context'] . '"/>' . "\n" ;
    echo '    </variables>' . "\n";
    echo '   </user>' . "\n";
    echo '  </domain>' . "\n";
    echo ' </section>' . "\n";
    echo '</document>' . "\n";
  }
  
enable freeswitch use mysql:
Enable Freeswitch use mysql instead of sqlite

  1: yum install unixODBC-devel mysql-connector-odbc mysql-server

  2: edit file /etc/odbcinst.ini:
[MySQL]
Description     = ODBC for MySQL
#check file libmyodbc3_r.so + libodbcmyS.so in the folder /usr/lib
Driver          = /usr/lib/libmyodbc3_r.so
Setup           = /usr/lib/libodbcmyS.so
Driver64        = /usr/lib64/libmyodbc3_r.so
Setup64         = /usr/lib64/libodbcmyS.so
FileUsage       = 1

  3: edit file /etc/odbc.ini:
[freeswitch]
Driver          = MySQL
SERVER          = 127.0.0.1
PORT            = 3306
DATABASE        = freeswitch
OPTION          = 67108864
Socket          = /var/lib/mysql/mysql.sock
USER            = test2            # insert your db username
PASSWORD        = pass    # insert your db password here

  4: edit file /opt/freeswitch/conf/sip_profiles/internal.xml
    <!--<param name="odbc-dsn" value="dsn:user:pass"/>--> change to     <param name="odbc-dsn" value="freeswitch:test2:pass"/>
	
  5: if you dont edit file /opt/freeswitch/conf/autoload_configs/switch.conf.xml and change the below line:
    <!-- <param name="core-db-dsn" value="dsn:username:password" /> -->
    <param name="core-db-dsn" value="freeswitch:test2:pass" />	
cai dat monit:
	wget http://pkgs.repoforge.org/monit/monit-5.4-1.el5.rf.i386.rpm
	rpm -ivh monit-5.4-1.el5.rf.i386.rpm
	file config : /etc/monit.conf
cau hinh monit de monitor cac service tren server
	1.	service httpd co cau hinh :
		check process apache with pidfile /var/run/httpd.pid
		group apache		
		start program = "/etc/init.d/httpd start"
		stop program  = "/etc/init.d/httpd stop"
		if failed host 127.0.0.1 port 80 then restart
		if 5 restarts within 5 cycles then timeout
	2.	service mysqld co cau hinh:
		check process mysqld with pidfile /var/run/mysqld/mysqld.pid
		group mysql
		start program = "/etc/init.d/mysqld start"
		stop program = "/etc/init.d/mysqld stop"
		if failed host 127.0.0.1 port 3306 then restart
		if 5 restarts within 5 cycles then timeout
	3.	service freeswitch co cau hinh:
		check process sip with pidfile /var/run/freeswitch/freeswitch.pid
		group freeswitch
		start program = "/etc/init.d/freeswitch start"
		stop  program = "/etc/init.d/freeswitch stop"
		if failed host 127.0.0.1 port 8021 type TCP then restart
		if 5 restarts within 5 cycles then timeout
	4.	config monit de dung web :
		vi /etc/monit.conf:
			set httpd port 2812 and
			#use address localhost  # only accept connection from localhost
			allow 172.30.41.241/255.255.255.0        # allow localhost to connect to the server and
			allow localhost        # allow localhost to connect to the server and
			allow admin:monit      # require user 'admin' with password 'monit'
			allow @monit           # allow users of group 'monit' to connect (rw)
			allow @users readonly  # allow users of group 'users' to connect readonly

cai dat unbound dns

	1.	unbound.conf:
	#
# See unbound.conf(5) man page.
#
# this is a comment.

#Use this to include other text into the file.
#include: "otherfile.conf"

# The server clause sets the main parameters.
server:
        verbosity: 1
        statistics-interval: 0
        statistics-cumulative: no
        extended-statistics: yes
        num-threads: 2
         interface: 0.0.0.0
        # port to answer queries from
         port: 53
        # Enable IPv4, "yes" or "no".
         do-ip4: yes
        # Enable IPv6, "yes" or "no".
        do-ip6: no
        # Enable UDP, "yes" or "no".
         do-udp: yes
        # Enable TCP, "yes" or "no".
         do-tcp: no
        local-zone: "sia-HCM1CA146.fpt.net" static
        local-data: "sia-HCM1CA146.fpt.net IN A 118.69.239.242"
        local-data-ptr: "118.69.239.242 sia-HCM1CA146.fpt.net"


# Remote control config section.
remote-control:
        control-enable: yes
        # unbound server key file.
        server-key-file: "/etc/unbound/unbound_server.key"
        # unbound server certificate file.
        server-cert-file: "/etc/unbound/unbound_server.pem"
        # unbound-control key file.
        control-key-file: "/etc/unbound/unbound_control.key"
        # unbound-control certificate file.
        control-cert-file: "/etc/unbound/unbound_control.pem"
 forward-zone:
        name: "."
        forward-addr: 8.8.8.8




	